from scheduler import Scheduler
from timestamp import Timestamp
from my_calendar import Calendar

def menu():
    scheduler = Scheduler()
    print(r"""
     __          ________ _      _____ ____  __  __ ______   _______ ____          
     \ \        / /  ____| |    / ____/ __ \|  \/  |  ____| |__   __/ __ \         
      \ \  /\  / /| |__  | |   | |   | |  | | \  / | |__       | | | |  | |        
       \ \/  \/ / |  __| | |   | |   | |  | | |\/| |  __|      | | | |  | |         _____   __   __
        \  /\  /  | |____| |___| |___| |__| | |  | | |____     | | | |__| |        |_   _| |  \ /  |
  _  __  \/  \/   |______|______\_____\____/|_|  |_|______|    |_|  \____/  __  __   | |   | | V | |
 | |/ /    /\        /\   |  \/  | |__   __|/\   |  \/  |   /\        /\   |  \/  |  |_|   |_|   |_|
 | ' /    /  \      /  \  | \  / |    | |  /  \  | \  / |  /  \      /  \  | \  / |
 |  <    / /\ \    / /\ \ | |\/| |    | | / /\ \ | |\/| | / /\ \    / /\ \ | |\/| |
 | . \  / ____ \  / ____ \| |  | |    | |/ ____ \| |  | |/ ____ \  / ____ \| |  | |
 |_|\_\/_/    \_\/_/    \_\_|  |_|    |_/_/    \_\_|  |_/_/    \_\/_/    \_\_|  |_|
""")
    while True:
        print("\n1Ô∏è‚É£  Add Task ‚ûï")
        print("2Ô∏è‚É£  Edit Task ‚úè")
        print("3Ô∏è‚É£  Complete Task ‚úÖ")
        print("4Ô∏è‚É£  Display Tasks üìú")
        print("5Ô∏è‚É£  Refresh Schedule üîÑ ")
        print("6Ô∏è‚É£  Display Calendar üìÜ")
        print("7Ô∏è‚É£  Clear Calendar üóë")
        print("8Ô∏è‚É£  Exit üö™")
        choice = input("Enter your choice: ")


        if choice == "1":
            try:
                try:
                    name = input("üìù Enter task name: ")
                    description = input("üìù Enter task description: ")
                    priority = int(input("‚ö° Enter priority level (0-10): "))
                    if priority < 0 or priority > 10:
                        print("‚ùå Invalid input. Please try again.")
                        continue
                    difficulty = int(input("üõ† Enter difficulty level (0-10): "))
                    if difficulty < 0 or difficulty > 10:
                        print("‚ùå Invalid input. Please try again.")
                        continue
                    duration = float(input("‚è≥ Enter task duration in hours: "))
                    if duration < 0:
                        print("‚ùå Invalid input. Please try again.")
                        continue

                    deadline = Timestamp.getDate(input("üìÖ Enter deadline (YYYY-MM-DD HH:MM or HH:MM or YYYY-MM-DD): "))
                    if deadline is None:
                        continue

                    start_time = Timestamp.getDate(input("üïí Enter start time (YYYY-MM-DD HH:MM or HH:MM or YYYY-MM-DD): "))
                    if start_time is None:
                        continue

                except ValueError:
                    print("‚ùå Invalid input. Please try again.")
                    continue

                delayable_input = input("‚è≥ Is task delayable? (y/n): ")
                if delayable_input == "y":
                    delayable = True
                elif delayable_input == "n":
                    delayable = False
                else:
                    print("‚ùå Invalid input. Task will be considered delayable by default.")
                    delayable = True

                repeat = 1
                r_input = input("üîÑ Is task recurring? (y/n): ")
                if r_input == "y":
                    recurring = ""
                    while recurring != "d" and recurring != "w" and recurring != "m":
                        recurring = input("üîÅ Enter recurring interval (daily (d), weekly (w), monthly (m)): ")
                        if recurring != "d" and recurring != "w" and recurring != "m":
                            print("‚ùå Invalid input. Please try again.")
                    repeat = int(input("üî¢ How many times should the task repeat? >"))
                    if repeat < 1:
                        print("‚ùå Invalid input. Task will be considered non-recurring by default.")
                        repeat = 1
                    elif repeat > 100:
                        repeat = 100
                elif r_input == "n":
                    recurring = ""
                else:
                    print("‚ùå Invalid input. Task will be considered non-recurring by default.")
                    recurring = ""

                scheduler.add_task(name, description, priority, difficulty, duration, 
                                deadline, start_time, start_time.addMinutes(duration*60), delayable, recurring, repeat)

                print("‚úÖ Task added successfully!\n")
                scheduler.task_handler.save_tasks(scheduler.tasks)
            except ValueError or IndexError or KeyError or AttributeError or TypeError or EOFError:
                print("‚ùå Invalid input. Please try again.")
                continue
        elif choice == "2":
            try:
                if not scheduler.tasks:
                    print("üìã No tasks to edit.\n")
                    continue
                try:
                    task_id = int(input("üî¢ Enter task ID to edit: "))
                except ValueError:
                    print("‚ùå Invalid input. Please try again.")
                    continue

                task = scheduler.get_task(task_id)
                if task is None:
                    print("üîç Task not found. Please try again.")
                    continue

                print("‚úÖ Task found:")
                print(task)
                print("‚úè Edit task:")
                print("1. Name üìù")
                print("2. Description üìù")
                print("3. Priority ‚ö°")
                print("4. Difficulty üõ†")
                print("5. Duration ‚è≥")
                print("6. Deadline üìÖ")
                print("7. Start Time üïí")
                print("8. Delayable ‚è≥")
                print("9. Recurring üîÑ")
                print("10. Cancel ‚ùå")
                edit_choice = input("‚û° Enter your choice: ")

                if edit_choice == "1":
                    name = input("üìù Enter new task name: ")
                    task.set_name(name)
                    print("‚úÖ Task name updated successfully!\n")

                elif edit_choice == "2":
                    description = input("üìù Enter new task description: ")
                    task.description = description
                    print("‚úÖ Task description updated successfully!\n")

                elif edit_choice == "3":
                    try:
                        priority = int(input("‚ö° Enter new priority level (1-10): "))
                    except ValueError:
                        print("‚ùå Invalid input. Please try again.")
                        continue
                    task.set_priority(priority)
                    print("‚úÖ Task priority updated successfully!\n")

                elif edit_choice == "4":
                    try:
                        difficulty = int(input("üõ† Enter new difficulty level (1-10): "))
                    except ValueError:
                        print("‚ùå Invalid input. Please try again.")
                        continue
                    task.set_difficulty(difficulty)
                    print("‚úÖ Task difficulty updated successfully!\n")

                elif edit_choice == "5":
                    try:
                        duration = float(input("‚è≥ Enter new task duration in hours: "))
                    except ValueError:
                        print("‚ùå Invalid input. Please try again.")
                        continue
                    task.set_duration(duration)
                    print("‚úÖ Task duration updated successfully!\n")

                elif edit_choice == "6":
                    deadline = Timestamp.getDate(input("üìÖ Enter new deadline (YYYY-MM-DD HH:MM or HH:MM or YYYY-MM-DD): "))
                    if deadline is None:
                        continue
                    task.set_deadline(deadline)
                    print("‚úÖ Task deadline updated successfully!\n")

                elif edit_choice == "7":
                    start_time = Timestamp.getDate(input("üïí Enter new start time (YYYY-MM-DD HH:MM or HH:MM or YYYY-MM-DD): "))
                    if start_time is None:
                        continue
                    task.set_start_time(start_time)
                    print("‚úÖ Task start time updated successfully!\n")

                elif edit_choice == "8":
                    delayable_input = input("‚è≥ Is task delayable? (y/n): ")
                    if delayable_input == "y":
                        delayable = True
                    elif delayable_input == "n":
                        delayable = False
                    else:
                        print("‚ùå Invalid input. Task will be considered delayable by default.")
                        delayable = True
                    task.set_delayable(delayable)
                    print("‚úÖ Task delayable status updated successfully!\n")

                elif edit_choice == "9":
                    repeat = 1
                    r_input = input("üîÑ Is task recurring? (y/n): ")
                    if r_input == "y":
                        recurring = ""
                        while recurring != "d" and recurring != "w" and recurring != "m":
                            recurring = input("üîÅ Enter new recurring interval (daily (d), weekly (w), monthly (m)): ")
                            if recurring != "d" and recurring != "w" and recurring != "m":
                                print("‚ùå Invalid input. Please try again.")
                        repeat = int(input("üî¢ How many times should the task repeat? >"))
                        if repeat < 1:
                            print("‚ùå Invalid input. Task will be considered non-recurring by default.")
                            repeat = 1
                        elif repeat > 1000:
                            repeat = 1000
                    elif r_input == "n":
                        recurring = ""
                    else:
                        print("‚ùå Invalid input. Task will be considered non-recurring by default.")
                        recurring = ""
                    task.set_repeat(repeat)
                    task.set_recurring(recurring)
                    print("‚úÖ Task recurring status updated successfully!\n")

                elif edit_choice == "10":
                    print("‚ùå Edit cancelled.\n")

                scheduler.task_handler.save_tasks(scheduler.tasks)

            except ValueError or IndexError or KeyError or AttributeError or TypeError or EOFError:
                print("Invalid input. Please try again.")
                continue
        elif choice == "3":
            if not scheduler.tasks:
                print("No tasks to complete.\n")
                continue
            try:
                task_id = int(input("Enter task ID to complete: "))
            except ValueError or TypeError:
                print("Invalid input. Please try again.")
                continue

            task = scheduler.get_task(task_id)
            if task is None:
                print("Task not found. Please try again.")
                continue

            task.set_completed(True)
            scheduler.remove_task(task)
            scheduler.calendar.removeTask(task)
            scheduler.task_handler.save_tasks(scheduler.tasks)
            print("Task completed successfully!\n")
        elif choice == "4":
            scheduler.display_tasks()

        elif choice == "5":
            scheduler.solve_schedule()
            scheduler.task_handler.save_tasks(scheduler.tasks)

        elif choice == "6":
            try:
                if not scheduler.tasks:
                    print("üìã No tasks to display.\n")
                    continue

                print("üîÑ Optimising schedule...")
                scheduler.solve_schedule()

                while True:
                    print("üìÖ Schedule Options:")
                    print("1. Display day schedule üìÜ")
                    print("2. Display month schedule üóì")
                    print("3. Display year schedule üóì")
                    choice = input("‚û° Enter your choice: ")

                    if choice == "1":
                        day = int(input("üìÜ Enter day to display (1-31): "))
                        month = int(input("üóì Enter month to display (1-12): "))
                        scheduler.calendar.displayDailyTasks(month, day)
                        break
                    elif choice == "2":
                        month = int(input("üóì Enter month to display (1-12): "))
                        scheduler.calendar.displayMonthlyCalendar(month)
                        break
                    elif choice == "3":
                        scheduler.calendar.displayYearlyCalendar()
                        break
                    else:
                        print("‚ùå Invalid choice. Please try again.")

            except ValueError or IndexError or KeyError or AttributeError or TypeError or EOFError:
                print("Invalid input. Please try again.")
                continue

        elif choice == "7":
            scheduler.tasks = []
            scheduler.calendar.clearCalendar()
            scheduler.task_handler.save_tasks(scheduler.tasks)
            print("üóë Calendar cleared.\n")

        elif choice == "8":
            print("üëã Exiting the Task Management System. Goodbye! üö™")
            break
        else:
            print("‚ùå Invalid choice. Please try again. üîÑ\n")